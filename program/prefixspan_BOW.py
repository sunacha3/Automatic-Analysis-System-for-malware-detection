import os
import csv
import api

def sequence(filepath):
  f = open(filepath)
  data = csv.reader(f)
  pat = []
  for row in data:
    word = []
    for i in range(int(row[0])):
      word.append(row[2+i])
    pat.append(word)
  seq = []
  for s in pat:
    w=""
    for i in range(len(s)):
      if i==len(s)-1:
        w = w+s[i]
      else:
        w = w+s[i]+":"
    seq.append(w)
  return pat,seq

def main(l=0):
  cor_dir="./../correct_data/"
  mal_dir = "./../malware_data/"
  pat,seq = sequence('./../p_result/'+str(l)+'backdoor.csv')
  pat2,seq2 = sequence('./../p_result/'+str(l)+'correct.csv')
  pat3,seq3 = sequence('./../p_result/'+str(l)+'trojan.csv')
  pat4,seq4 = sequence('./../p_result/'+str(l)+'virus.csv')
  level = l
  pat = pat + pat2 #+ pat3 + pat4
  seq = seq + seq2 #+ seq3 + seq4
  cor_dirs = api.getdirs(cor_dir)
  mal_dirs = api.getdirs(mal_dir)
  pat2,seq2 = seq('./../p_result/correct.csv')
  write_bow(seq,pat,cor_dir,cor_dirs,"cor_prefix.txt",level)
  write_bow(seq,pat,mal_dir,mal_dirs,"mal_prefix.txt",level)

def write_bow(seq,pat,dir,dirs,out_file,level):
  out=open('./../feature/'+out_file,'w')
  seq_dict={}
  first = False
  for d in dirs:
    print "open %s"%d
    cfiles = os.listdir(dir+d+'/index/')
    for file in cfiles:
      if file.endswith('.csv'):
        if file[-5] == str(level):
          f=open(dir+d+'/index/'+file,"r")
          data = csv.reader(f)
          st=[]
          for word in data:
            st.append(word[1])
          for i in range(len(pat)):
            num = 0
            for j in range(len(pat[i])):
              if pat[i][j] in st:
                if j == 0:
                  tmp = st.index(pat[i][j])
                  num += 1
                elif tmp < st.index(pat[i][j]):
                  tmp = st.index(pat[i][j])
                  num += 1
              else: break
            if num == len(pat[i]):
              seq_dict[seq[i]]=1
            else:
              seq_dict[seq[i]]=0
          if first==False:
            out.write('Api')
            for k in seq_dict.keys():
              out.write('\t%s' % k)
            out.write('\n')
          first = True
          out.write(file[:-11])
  #      print file[:-11]
          for v in seq_dict.values():
            out.write('\t%d' % v)
          out.write('\n')
          seq_dict = init(seq_dict)
          f.close()
  out.close()
                
def init(worddict):
  for k in worddict.keys():
    k = k.rstrip()
    worddict[k]=0
  return worddict            

if __name__ == '__main__':
  main(l=0)
