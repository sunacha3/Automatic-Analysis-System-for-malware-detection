import os
import api
import sys
import re 
import csv

def create_dic(dirs,dir_path,dic,level):
  for dir in dirs:
    print "open %s to create dictionary" % dir
    files = os.listdir(dir_path+dir)
    for filename in files:
      if filename.endswith('.txt'):
        number = re.findall(r"[0-9]+",filename)
        if int(number[1]) == level:
          filepath = dir_path+dir+'/'+filename
          f = open(filepath).read()
          api = f.split("\n")
          api.remove("")
          for i in api:
            dic[i] = 0
  return dic

def index(dirs,dir_path,dic,level):
  for dir in dirs:
    files = os.listdir(dir_path+dir)
    if os.path.isdir(dir_path+dir+"/index")==False:
      print "Create dir..."
      os.mkdir(dir_path+dir+"/index/")
    for filename in files:
      if filename.endswith('.txt'):
        number = re.findall(r"[0-9]+",filename)
        if int(number[1]) == level:
          filepath = dir_path+dir+'/'+filename
          f = open(filepath).read()
          #out = open(dir_path+dir+"/index/"+filename,"w")
          api = f.split("\n")
          api.remove("")
          items=[]
          for i in api:
            item=[]
            item.append(1)
            item.append(dic[i])
            items.append(item) 
            #out.write(str(dic[i])+"\n")
          save = csv.writer(file(dir_path+dir+"/index/"+filename[:-4]+".csv","w"),lineterminator='\n')
          save.writerows(items)

def main(level=0,ngram=0):
  print "Creating dictionary!"
  if ngram == 0:
    cor_dir = "./../correct_data/"
    mal_dir = "./../malware_data/"
  elif ngram == 1:
    cor_dir = "./../n-gram/cor/" 
    mal_dir = "./../n-gram/mal/"
  else:
    print "input error:-n 's number must be 0 or 1!"
    sys.exit()
  cor_dirs = api.getdirs(cor_dir)
  mal_dirs = api.getdirs(mal_dir)
  dic = {}
  dic = create_dic(cor_dirs,cor_dir,dic,level)
  dic = create_dic(mal_dirs,mal_dir,dic,level)
  num = 0
  for i in dic.keys():
    dic[i] += num
    num += 1
  items = dic.items()
  item=[]
  for i in items:
    item.append(list(i))
  save = csv.writer(file("./../dictionary/dic.csv","w"),lineterminator='\n')
  save.writerows(item)
  index(cor_dirs,cor_dir,dic,level)
  index(mal_dirs,mal_dir,dic,level)
